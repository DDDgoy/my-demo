<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°è°¢èºè›³ç²‰ Â· ç®¡ç†ç³»ç»Ÿ</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap');
:root{
  --red:#E8341A;--red-dark:#C02A12;--orange:#F5A623;
  --cream:#FFF8F0;--dark:#1A0A00;--mid:#6B3A1F;--light:#F9EFE4;
  --green:#2D7A3A;--green-light:#E8F5EA;--blue:#1976D2;--blue-light:#E3F2FD;
  --purple:#7B1FA2;--purple-light:#F3E5F5;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans SC',sans-serif;background:#0f0f0f;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:16px;gap:14px;}
h1.title{color:#fff;font-size:18px;font-weight:700;letter-spacing:2px;text-align:center;padding-top:8px;}
.subtitle{color:#666;font-size:11px;text-align:center;}

/* â”€â”€ PHONE FRAME â”€â”€ */
.phones-row{display:flex;gap:24px;flex-wrap:wrap;justify-content:center;align-items:flex-start;}
.phone-wrap{display:flex;flex-direction:column;align-items:center;gap:6px;}
.phone-label{color:#555;font-size:10px;letter-spacing:1px;text-transform:uppercase;}
.phone{width:360px;height:730px;background:var(--cream);border-radius:38px;overflow:hidden;
  box-shadow:0 30px 80px rgba(0,0,0,0.7),0 0 0 2px #2a2a2a;position:relative;display:flex;flex-direction:column;}

/* â”€â”€ TOP TAB BAR â”€â”€ */
.tab-bar{display:flex;background:#1a1a1a;border-radius:50px;padding:4px;gap:4px;}
.tab-btn{padding:8px 18px;border-radius:50px;border:none;font-family:'Noto Sans SC',sans-serif;
  font-size:12px;font-weight:500;cursor:pointer;transition:all 0.2s;color:#666;background:transparent;}
.tab-btn.active{background:var(--red);color:#fff;}

/* â”€â”€ HEADERS â”€â”€ */
.c-header{background:var(--red);padding:34px 18px 13px;position:relative;overflow:hidden;flex-shrink:0;}
.c-header::before{content:'ğŸœ';position:absolute;right:-8px;top:8px;font-size:68px;opacity:0.14;}
.c-header .shop-name{font-size:16px;font-weight:900;color:#fff;}
.c-header .shop-sub{font-size:10px;color:rgba(255,255,255,0.6);margin-top:2px;}
.c-header .table-tag{display:inline-block;background:rgba(255,255,255,0.18);color:#fff;font-size:10px;padding:2px 9px;border-radius:16px;margin-top:5px;}
.m-header{background:var(--dark);padding:32px 18px 12px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.m-title{font-size:15px;font-weight:700;color:#fff;}
.m-sub{font-size:10px;color:rgba(255,255,255,0.4);margin-top:2px;}

/* â”€â”€ CAT TABS â”€â”€ */
.cat-tabs{display:flex;gap:5px;padding:9px 13px;background:#fff;overflow-x:auto;
  border-bottom:1px solid #f0e8e0;flex-shrink:0;scrollbar-width:none;}
.cat-tab{padding:4px 12px;border-radius:16px;font-size:12px;font-weight:500;white-space:nowrap;
  cursor:pointer;transition:all 0.15s;background:var(--light);color:var(--mid);}
.cat-tab.active{background:var(--red);color:#fff;}

/* â”€â”€ MENU ITEMS â”€â”€ */
.menu-list{flex:1;overflow-y:auto;padding:10px 12px;scrollbar-width:none;background:var(--cream);}
.menu-section-title{font-size:10px;color:#bbb;font-weight:600;margin:5px 0 7px;letter-spacing:1px;}
.menu-item{background:#fff;border-radius:14px;padding:11px;margin-bottom:9px;display:flex;gap:10px;
  align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.05);cursor:pointer;transition:transform 0.12s;}
.menu-item:active{transform:scale(0.98);}
.menu-item.soldout-item{opacity:0.5;cursor:default;}
.item-emoji{font-size:30px;width:42px;text-align:center;flex-shrink:0;}
.item-info{flex:1;min-width:0;}
.item-name{font-size:14px;font-weight:700;color:var(--dark);}
.item-desc{font-size:10px;color:#bbb;margin-top:1px;line-height:1.4;}
.item-small{font-size:9px;color:#ccc;margin-top:2px;font-style:italic;}
.item-tags{display:flex;gap:3px;margin-top:4px;flex-wrap:wrap;}
.item-tag{font-size:9px;padding:1px 5px;border-radius:3px;background:#FFF3CD;color:#856404;}
.item-tag.hot{background:#FFE4E0;color:var(--red);}
.item-price-add{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0;}
.item-price{font-size:15px;font-weight:700;color:var(--red);}
.item-price.soldout{color:#bbb;text-decoration:line-through;font-size:12px;}
.soldout-badge{font-size:9px;background:#f0f0f0;color:#aaa;padding:2px 7px;border-radius:8px;font-weight:600;}
.add-btn{width:26px;height:26px;border-radius:50%;background:var(--red);color:#fff;border:none;
  font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

/* â”€â”€ CART BAR â”€â”€ */
.cart-bar{background:var(--dark);margin:8px 12px 12px;border-radius:14px;padding:12px 15px;
  display:flex;align-items:center;gap:10px;cursor:pointer;flex-shrink:0;transition:opacity 0.2s;}
.cart-bar.empty{opacity:0.35;cursor:default;}
.cart-icon{font-size:20px;position:relative;}
.cart-badge{position:absolute;top:-5px;right:-7px;background:var(--orange);color:#fff;
  font-size:9px;font-weight:700;width:16px;height:16px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;}
.cart-text{flex:1;color:#fff;font-size:13px;font-weight:500;}
.cart-total{color:var(--orange);font-size:17px;font-weight:700;}

/* â”€â”€ OVERLAY SYSTEM â”€â”€ */
.ov{position:absolute;inset:0;background:rgba(0,0,0,0.52);display:flex;align-items:flex-end;
  z-index:10;opacity:0;pointer-events:none;transition:opacity 0.25s;}
.ov.show{opacity:1;pointer-events:all;}
.ov.center{align-items:center;justify-content:center;padding:16px;}
.sheet{background:#fff;border-radius:22px 22px 0 0;width:100%;max-height:92%;
  overflow-y:auto;padding-bottom:18px;transform:translateY(28px);transition:transform 0.28s;scrollbar-width:none;}
.ov.show .sheet{transform:translateY(0);}
.sheet-hd{padding:16px 16px 11px;border-bottom:1px solid #f5f5f5;display:flex;
  justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:1;}
.sheet-title{font-size:15px;font-weight:700;color:var(--dark);}
.close-btn{background:#f0f0f0;border:none;width:26px;height:26px;border-radius:50%;
  font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* â”€â”€ CUSTOMIZE MODAL â”€â”€ */
.opt-grp{padding:11px 16px 0;}
.opt-title{font-size:12px;font-weight:700;color:var(--dark);margin-bottom:8px;display:flex;align-items:center;gap:5px;flex-wrap:wrap;}
.req-tag{font-size:9px;background:#FFE4E0;color:var(--red);padding:1px 5px;border-radius:3px;}
.opt-tag{font-size:9px;color:#bbb;}
.opt-chips{display:flex;flex-wrap:wrap;gap:6px;}
.chip{padding:5px 11px;border-radius:16px;border:1.5px solid #e8e8e8;font-size:11px;cursor:pointer;
  transition:all 0.12s;color:#555;background:#fff;white-space:nowrap;user-select:none;}
.chip.sel{border-color:var(--red);background:#FFF0EE;color:var(--red);font-weight:600;}
.chip.multi.sel{border-color:var(--green);background:var(--green-light);color:var(--green);}
.chip.combo.sel{border-color:var(--orange);background:#FFF8ED;color:var(--orange);font-weight:600;}
.chip.disabled{border-color:#f0f0f0;background:#fafafa;color:#ccc;cursor:not-allowed;pointer-events:none;}

/* â”€â”€ TOPPING GRID (with qty) â”€â”€ */
.topping-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.top-item{padding:8px 10px;border-radius:10px;border:1.5px solid #e8e8e8;transition:all 0.12s;
  display:flex;justify-content:space-between;align-items:center;gap:6px;}
.top-item.has-qty{border-color:var(--orange);background:#FFF8ED;}
.top-name{font-size:11px;color:var(--dark);flex:1;}
.top-right{display:flex;align-items:center;gap:4px;flex-shrink:0;}
.top-price{font-size:10px;color:var(--orange);font-weight:600;}
.top-qty-ctrl{display:flex;align-items:center;gap:3px;}
.tqb{width:20px;height:20px;border-radius:50%;border:1.5px solid;font-size:12px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;background:#fff;line-height:1;font-weight:700;}
.tqb.minus{border-color:var(--red);color:var(--red);}
.tqb.plus{background:var(--orange);border-color:var(--orange);color:#fff;}
.tqb.plus-only{background:var(--orange);border-color:var(--orange);color:#fff;}
.tqb-num{font-size:12px;font-weight:700;color:var(--dark);min-width:14px;text-align:center;}

.note-input{width:100%;border:1.5px solid #e8e8e8;border-radius:10px;padding:9px 11px;
  font-family:'Noto Sans SC',sans-serif;font-size:12px;resize:none;outline:none;color:var(--dark);}
.note-input:focus{border-color:var(--red);}
.note-counter{font-size:10px;color:#bbb;text-align:right;margin-top:3px;}
.confirm-btn{margin:14px 16px 0;width:calc(100% - 32px);background:var(--red);color:#fff;
  border:none;border-radius:12px;padding:14px;font-family:'Noto Sans SC',sans-serif;
  font-size:14px;font-weight:700;cursor:pointer;}

/* â”€â”€ CART SHEET â”€â”€ */
.csi{display:flex;align-items:flex-start;gap:8px;padding:10px 0;border-bottom:1px solid #f5f5f5;}
.csi:last-child{border-bottom:none;}
.csi-info{flex:1;}
.csi-name{font-size:13px;font-weight:700;color:var(--dark);}
.csi-spec{font-size:9px;color:#bbb;margin-top:2px;line-height:1.5;}
.csi-price{font-size:13px;font-weight:700;color:var(--red);flex-shrink:0;margin-right:8px;}
.qty-ctrl{display:flex;align-items:center;gap:6px;flex-shrink:0;}
.qb{width:24px;height:24px;border-radius:50%;border:1.5px solid;font-size:14px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-weight:700;line-height:1;}
.qb.minus{border-color:var(--red);color:var(--red);background:#fff;}
.qb.plus{background:var(--red);border-color:var(--red);color:#fff;}
.qb-num{font-size:14px;font-weight:700;color:var(--dark);min-width:14px;text-align:center;}
.cart-total-row{display:flex;justify-content:space-between;align-items:center;
  padding:12px 16px;border-top:2px solid #f5f5f5;background:#fff;position:sticky;bottom:0;}
.submit-btn{margin:10px 16px 0;width:calc(100% - 32px);background:var(--red);color:#fff;
  border:none;border-radius:12px;padding:14px;font-family:'Noto Sans SC',sans-serif;
  font-size:15px;font-weight:700;cursor:pointer;}

/* â”€â”€ CUSTOMER ORDER STATUS â”€â”€ */
.os-hd{flex-shrink:0;padding:34px 18px 20px;color:#fff;position:relative;overflow:hidden;}
.os-hd.making{background:linear-gradient(135deg,var(--red),var(--red-dark));}
.os-hd.ready{background:linear-gradient(135deg,var(--green),#1a5c27);}
.os-hd.paid{background:linear-gradient(135deg,#555,#333);}
.os-hd::before{content:'ğŸœ';position:absolute;right:-8px;top:8px;font-size:76px;opacity:0.1;}
.os-num-label{font-size:10px;opacity:0.7;margin-bottom:4px;}
.os-big-num{font-size:54px;font-weight:900;line-height:1;letter-spacing:-2px;}
.os-pill{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,0.18);
  padding:4px 12px;border-radius:16px;font-size:12px;font-weight:600;margin-top:8px;}
.os-dot{width:6px;height:6px;border-radius:50%;background:#fff;animation:pulse 1.2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.25}}
.os-body{flex:1;overflow-y:auto;background:var(--cream);padding:12px;scrollbar-width:none;}
.os-card{background:#fff;border-radius:16px;padding:14px;margin-bottom:9px;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.os-card-title{font-size:11px;color:#999;margin-bottom:11px;font-weight:600;}
.os-step{display:flex;gap:11px;align-items:flex-start;}
.os-step-left{display:flex;flex-direction:column;align-items:center;}
.os-circle{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;}
.os-circle.done{background:var(--green);color:#fff;}
.os-circle.active{background:var(--red);color:#fff;}
.os-circle.pending{background:#f0f0f0;color:#ccc;}
.os-line{width:2px;height:20px;background:#f0f0f0;margin:2px 0;}
.os-line.done{background:var(--green);}
.os-step-info{padding-top:2px;flex:1;padding-bottom:14px;}
.os-step-name{font-size:12px;font-weight:600;color:var(--dark);}
.os-step-sub{font-size:10px;color:#999;margin-top:1px;}
.pay-prompt{background:linear-gradient(135deg,var(--green),#1a5c27);border-radius:14px;
  padding:16px;color:#fff;text-align:center;margin-bottom:9px;}
.pp-title{font-size:13px;font-weight:700;margin-bottom:5px;}
.pp-price{font-size:42px;font-weight:900;letter-spacing:-1px;}
.pp-sub{font-size:10px;opacity:0.75;margin-top:5px;}

/* â”€â”€ MERCHANT NAV â”€â”€ */
.m-nav{display:flex;background:#fff;border-bottom:1px solid #f0f0f0;flex-shrink:0;}
.m-nav-btn{flex:1;padding:10px;border:none;background:transparent;
  font-family:'Noto Sans SC',sans-serif;font-size:11px;font-weight:500;cursor:pointer;
  color:#999;border-bottom:2px solid transparent;transition:all 0.15s;}
.m-nav-btn.active{color:var(--red);border-bottom-color:var(--red);}
.m-content{flex:1;overflow-y:auto;background:#f5f1ed;scrollbar-width:none;}

/* â”€â”€ ORDER CARDS (merchant) â”€â”€ */
.orders-panel{padding:11px;}
.sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.sec-title{font-size:12px;font-weight:700;color:var(--dark);}
.sec-badge{background:var(--red);color:#fff;font-size:9px;font-weight:700;padding:2px 7px;border-radius:8px;}
.mc{background:#fff;border-radius:14px;margin-bottom:9px;box-shadow:0 2px 6px rgba(0,0,0,0.05);overflow:hidden;}
.mc-top{display:flex;justify-content:space-between;align-items:flex-start;padding:11px 13px 8px;cursor:pointer;}
.mc-left{display:flex;flex-direction:column;}
.mc-num{font-size:26px;font-weight:900;color:var(--dark);line-height:1;}
.mc-time{font-size:9px;color:#bbb;margin-top:1px;}
.mc-right{text-align:right;}
.mc-price{font-size:24px;font-weight:900;color:var(--red);line-height:1;}
.mc-badge{display:inline-block;font-size:9px;font-weight:600;padding:2px 8px;border-radius:12px;margin-top:3px;}
.mc-badge.new{background:#FFE4E0;color:var(--red);}
.mc-badge.making{background:#FFF3CD;color:#856404;}
.mc-badge.ready{background:var(--green-light);color:var(--green);}
.mc-badge.paid{background:#f0f0f0;color:#999;}
.mc-preview{font-size:10px;color:#888;padding:0 13px 8px;line-height:1.6;}
.mc-detail{padding:0 13px 10px;border-top:1px solid #f5f5f5;display:none;}
.mc-detail.open{display:block;}
.mc-detail-title{font-size:9px;color:#bbb;font-weight:600;letter-spacing:0.5px;margin:9px 0 6px;}
/* PRINT RECEIPT STYLE inside detail */
.receipt{background:#fafafa;border-radius:10px;padding:10px 12px;font-size:11px;line-height:1.8;}
.receipt-line{display:flex;justify-content:space-between;border-bottom:1px dashed #e8e8e8;padding:3px 0;}
.receipt-line:last-child{border-bottom:none;}
.receipt-line.total{font-weight:700;font-size:12px;border-top:2px solid #333;border-bottom:none;margin-top:4px;padding-top:6px;}
.receipt-spec{font-size:10px;color:#999;padding-left:8px;}
.mc-actions{display:flex;gap:6px;padding:0 13px 11px;}
.mc-reprint{font-size:9px;color:#bbb;padding:4px 0;text-align:center;cursor:pointer;text-decoration:underline;}
.abtn{flex:1;padding:8px;border-radius:8px;border:none;font-family:'Noto Sans SC',sans-serif;
  font-size:11px;font-weight:600;cursor:pointer;transition:opacity 0.15s;}
.abtn:active{opacity:0.8;}
.abtn.green{background:var(--green);color:#fff;}
.abtn.orange{background:var(--orange);color:#fff;}
.abtn.sec{background:#f0f0f0;color:#555;}
.abtn.red{background:var(--red);color:#fff;}

/* â”€â”€ ORDER TAB SUB-NAV â”€â”€ */
.order-sub-nav{display:flex;background:#fff;border-bottom:1px solid #eee;flex-shrink:0;}
.osn-btn{flex:1;padding:9px;border:none;background:transparent;font-family:'Noto Sans SC',sans-serif;
  font-size:11px;font-weight:500;cursor:pointer;color:#999;border-bottom:2px solid transparent;}
.osn-btn.active{color:var(--red);border-bottom-color:var(--red);}

/* â”€â”€ DATE FILTER â”€â”€ */
.date-filter{display:flex;gap:6px;padding:8px 11px;background:#fff;border-bottom:1px solid #f0f0f0;flex-shrink:0;overflow-x:auto;scrollbar-width:none;}
.df-btn{padding:4px 10px;border-radius:12px;border:1.5px solid #e8e8e8;font-size:10px;
  font-weight:500;cursor:pointer;white-space:nowrap;background:#fff;color:#666;font-family:'Noto Sans SC',sans-serif;}
.df-btn.active{background:var(--red);color:#fff;border-color:var(--red);}

/* â”€â”€ STATS â”€â”€ */
.stats-section{padding:11px;}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:9px;}
.stat-card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,0.04);cursor:pointer;transition:transform 0.1s;}
.stat-card:active{transform:scale(0.98);}
.stat-card.wide{grid-column:span 2;background:var(--red);}
.stat-label{font-size:10px;color:#999;margin-bottom:4px;}
.stat-card.wide .stat-label{color:rgba(255,255,255,0.65);}
.stat-val{font-size:22px;font-weight:900;color:var(--dark);}
.stat-card.wide .stat-val{color:#fff;font-size:28px;}
.stat-sub{font-size:9px;color:#bbb;margin-top:2px;}
.stat-card.wide .stat-sub{color:rgba(255,255,255,0.55);}
.chart-card{background:#fff;border-radius:12px;padding:13px;margin-bottom:9px;box-shadow:0 2px 6px rgba(0,0,0,0.04);}
.chart-title{font-size:12px;font-weight:700;color:var(--dark);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
.chart-title a{font-size:10px;color:var(--blue);cursor:pointer;font-weight:400;}
.bar-chart{display:flex;align-items:flex-end;gap:4px;height:70px;}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;}
.bar{width:100%;border-radius:3px 3px 0 0;background:var(--red);opacity:0.55;}
.bar.peak{opacity:1;}
.bar-lbl{font-size:8px;color:#bbb;}
.top-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #f8f8f8;}
.top-row:last-child{border-bottom:none;}
.rank{width:16px;font-size:10px;font-weight:700;color:#ccc;flex-shrink:0;}
.rank.gold{color:#F5A623;}.rank.silver{color:#999;}.rank.bronze{color:#CD7F32;}
.top-name{flex:1;font-size:11px;color:var(--dark);}
.top-bar-w{width:60px;height:4px;background:#f0f0f0;border-radius:2px;overflow:hidden;}
.top-bar-f{height:100%;border-radius:2px;background:var(--red);}
.top-cnt{font-size:10px;color:#999;width:24px;text-align:right;}
.dl-btn{width:100%;padding:11px;border-radius:10px;background:var(--blue);color:#fff;border:none;
  font-family:'Noto Sans SC',sans-serif;font-size:12px;font-weight:600;cursor:pointer;margin-top:2px;}

/* â”€â”€ MENU MANAGE â”€â”€ */
.mg-sec-title{font-size:10px;color:#aaa;font-weight:600;letter-spacing:1px;text-transform:uppercase;
  padding:9px 13px 5px;background:#f5f1ed;}
.mg-item{background:#fff;display:flex;justify-content:space-between;align-items:center;padding:9px 13px;border-bottom:1px solid #f8f8f8;}
.mg-name{font-size:11px;font-weight:600;color:var(--dark);}
.mg-price{font-size:10px;color:var(--red);font-weight:700;margin-top:1px;}
.mg-actions{display:flex;align-items:center;gap:6px;}
.ebtn{font-size:9px;padding:2px 7px;border-radius:5px;cursor:pointer;font-family:'Noto Sans SC',sans-serif;}
.ebtn.edit{border:1.5px solid #e8e8e8;background:#fff;color:#666;}
.ebtn.del{border:1.5px solid #FFE4E0;background:#fff;color:var(--red);}
.tog{width:32px;height:17px;background:#ddd;border-radius:9px;position:relative;cursor:pointer;transition:background 0.18s;flex-shrink:0;}
.tog.on{background:var(--green);}
.tog-knob{width:13px;height:13px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:left 0.18s;box-shadow:0 1px 3px rgba(0,0,0,0.2);}
.tog.on .tog-knob{left:17px;}

/* â”€â”€ PAYMENT MODAL â”€â”€ */
.pay-ov{position:absolute;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:flex-end;z-index:20;opacity:0;pointer-events:none;transition:opacity 0.25s;}
.pay-ov.show{opacity:1;pointer-events:all;}
.pay-sheet{background:#fff;border-radius:22px 22px 0 0;width:100%;padding-bottom:22px;transform:translateY(28px);transition:transform 0.28s;}
.pay-ov.show .pay-sheet{transform:translateY(0);}
.pay-hd{padding:18px 18px 14px;border-bottom:1px solid #f5f5f5;display:flex;justify-content:space-between;align-items:center;}
.pay-hd-title{font-size:15px;font-weight:700;color:var(--dark);}
.pay-order-block{text-align:center;padding:18px 18px 14px;border-bottom:1px solid #f5f5f5;}
.pay-order-num-lbl{font-size:12px;color:#999;margin-bottom:6px;}
.pay-amount{font-size:56px;font-weight:900;color:var(--red);letter-spacing:-2px;line-height:1;}
.pay-yuan{font-size:20px;font-weight:700;vertical-align:top;margin-top:10px;display:inline-block;}
.pay-method-title{font-size:10px;color:#aaa;padding:12px 18px 8px;font-weight:600;letter-spacing:0.5px;}
.pay-methods{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:0 18px;}
.pmb{padding:12px 8px;border-radius:12px;border:2px solid #f0f0f0;background:#fff;cursor:pointer;
  text-align:center;transition:all 0.12s;font-family:'Noto Sans SC',sans-serif;}
.pmb:active{transform:scale(0.97);}
.pmb.sel{border-color:var(--green);background:var(--green-light);}
.pmb.waive{border-color:#f0e8e0;background:#FFF8F4;}
.pmb.waive.sel{border-color:var(--orange);background:#FFF3E0;}
.pmb-icon{font-size:20px;margin-bottom:3px;}
.pmb-label{font-size:11px;font-weight:700;color:var(--dark);}
.waive-rs{padding:0 18px;margin-top:9px;display:none;flex-direction:column;gap:6px;}
.waive-rs.show{display:flex;}
.wr-btn{padding:10px 12px;border-radius:10px;border:1.5px solid #f0e8e0;background:#fff;
  text-align:left;cursor:pointer;font-family:'Noto Sans SC',sans-serif;font-size:12px;color:var(--dark);}
.wr-btn.sel{border-color:var(--orange);background:#FFF3E0;font-weight:600;color:var(--orange);}
.pay-confirm{margin:14px 18px 0;width:calc(100% - 36px);background:var(--green);color:#fff;border:none;
  border-radius:12px;padding:14px;font-family:'Noto Sans SC',sans-serif;font-size:14px;font-weight:700;cursor:pointer;}
.pay-confirm:disabled{background:#e0e0e0;color:#aaa;cursor:not-allowed;}

/* â”€â”€ CONFIRM DIALOG (reprint) â”€â”€ */
.confirm-dlg{background:#fff;border-radius:18px;padding:22px 20px;width:100%;max-width:300px;text-align:center;}
.cdlg-icon{font-size:32px;margin-bottom:8px;}
.cdlg-title{font-size:14px;font-weight:700;color:var(--dark);margin-bottom:6px;}
.cdlg-sub{font-size:11px;color:#999;line-height:1.6;margin-bottom:18px;}
.cdlg-btns{display:flex;gap:8px;}
.cdlg-btn{flex:1;padding:11px;border-radius:10px;border:none;font-family:'Noto Sans SC',sans-serif;font-size:13px;font-weight:600;cursor:pointer;}
.cdlg-btn.cancel{background:#f0f0f0;color:#555;}
.cdlg-btn.confirm{background:var(--orange);color:#fff;}

/* â”€â”€ DETAIL SHEET (stat drill-down) â”€â”€ */
.detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f8f8f8;font-size:12px;}
.detail-row:last-child{border-bottom:none;}
.detail-lbl{color:#555;}
.detail-val{font-weight:700;color:var(--dark);}
.detail-tag{font-size:9px;padding:1px 6px;border-radius:4px;margin-left:4px;}

/* â”€â”€ EDIT MODAL â”€â”€ */
.edit-ov{position:absolute;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;
  justify-content:center;z-index:20;opacity:0;pointer-events:none;transition:opacity 0.22s;padding:18px;}
.edit-ov.show{opacity:1;pointer-events:all;}
.edit-modal{background:#fff;border-radius:18px;width:100%;padding:18px;max-height:80%;overflow-y:auto;scrollbar-width:none;}
.edit-modal h3{font-size:14px;font-weight:700;color:var(--dark);margin-bottom:14px;}
.ef{margin-bottom:10px;}
.ef-label{font-size:10px;color:#999;margin-bottom:4px;}
.ef-input{width:100%;border:1.5px solid #e8e8e8;border-radius:8px;padding:8px 11px;
  font-family:'Noto Sans SC',sans-serif;font-size:12px;outline:none;color:var(--dark);}
.ef-input:focus{border-color:var(--red);}
.ef-row{display:flex;gap:7px;margin-top:14px;}
.ef-save{flex:1;background:var(--red);color:#fff;border:none;border-radius:8px;padding:10px;
  font-family:'Noto Sans SC',sans-serif;font-size:12px;font-weight:700;cursor:pointer;}
.ef-cancel{flex:1;background:#f0f0f0;color:#555;border:none;border-radius:8px;padding:10px;
  font-family:'Noto Sans SC',sans-serif;font-size:12px;font-weight:600;cursor:pointer;}

/* â”€â”€ PRINT NOTIF â”€â”€ */
.pn{position:absolute;top:14px;left:14px;right:14px;background:#111;color:#fff;border-radius:12px;
  padding:11px 13px;display:flex;align-items:center;gap:9px;z-index:30;
  transform:translateY(-130px);transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow:0 8px 24px rgba(0,0,0,0.5);}
.pn.show{transform:translateY(0);}
.pn-bar{height:3px;background:rgba(255,255,255,0.1);border-radius:2px;margin-top:6px;overflow:hidden;}
.pn-fill{height:100%;background:var(--orange);border-radius:2px;width:0;transition:width 2.8s linear;}

/* â”€â”€ SYNC INDICATOR â”€â”€ */
.sync-dot{width:7px;height:7px;border-radius:50%;background:#4CAF50;display:inline-block;animation:pulse 1.5s infinite;}
.sync-dot.error{background:var(--red);animation:none;}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(90px);
  background:#1a1a1a;color:#fff;padding:10px 20px;border-radius:40px;font-size:12px;
  font-family:'Noto Sans SC',sans-serif;transition:transform 0.3s;z-index:9999;white-space:nowrap;
  box-shadow:0 4px 16px rgba(0,0,0,0.3);}
</style>
</head>
<body>
<h1 class="title">ğŸœ å°è°¢èºè›³ç²‰</h1>
<p class="subtitle">å¤©ç©ºä¸€å·å…¬å¯“åº— Â· ç³»ç»Ÿæ¼”ç¤º v3.0 &nbsp; <span class="sync-dot" id="sync-dot"></span> å®æ—¶åŒæ­¥</p>
<div class="tab-bar">
  <button class="tab-btn active" onclick="showTab('menu',this)">é¡¾å®¢ç‚¹é¤</button>
  <button class="tab-btn" onclick="showTab('order',this)">æˆ‘çš„è®¢å•</button>
  <button class="tab-btn" onclick="showTab('merchant',this)">æ‘Šä¸»åå°</button>
</div>
<div class="phones-row">

<!-- â•â• CUSTOMER MENU PHONE â•â• -->
<div class="phone-wrap" id="view-menu">
  <div class="phone-label">é¡¾å®¢ç«¯ Â· ç‚¹é¤</div>
  <div class="phone">
    <div class="c-header">
      <div class="shop-name">å°è°¢èºè›³ç²‰</div>
      <div class="shop-sub">å¤©ç©ºä¸€å·å…¬å¯“åº— Â· å¤œå¸‚CåŒº 06å·æ‘Š</div>
      <span class="table-tag">ğŸ“ æ¡Œå· 08</span>
    </div>
    <div class="cat-tabs" id="customer-cat-tabs"></div>
    <div class="menu-list" id="customer-menu-list"></div>
    <div class="cart-bar empty" id="cart-bar" onclick="openCartSheet()">
      <div class="cart-icon">ğŸ›’<div class="cart-badge" id="cart-badge">0</div></div>
      <div class="cart-text">æŸ¥çœ‹è´­ç‰©è½¦</div>
      <div class="cart-total" id="cart-total-disp">Â¥0</div>
    </div>
    <!-- CUSTOMIZE MODAL -->
    <div class="ov" id="modal" onclick="maybeClose(event,'modal')">
      <div class="sheet">
        <div class="sheet-hd">
          <div>
            <div class="sheet-title" id="modal-item-name"></div>
            <div style="font-size:9px;color:#bbb;margin-top:2px;font-style:italic">å°æ–™ï¼šé…¸è±†è§’ã€é…¸ç¬‹ã€è…ç«¹ã€æœ¨è€³ä¸ã€èŠ±ç”Ÿç±³ã€è‘±</div>
            <div style="font-size:18px;font-weight:700;color:var(--red);margin-top:4px" id="modal-price">Â¥10</div>
          </div>
          <button class="close-btn" onclick="closeSheet('modal')">âœ•</button>
        </div>
        <div class="opt-grp">
          <div class="opt-title">ç²‰å‹ <span class="req-tag">å¿…é€‰</span></div>
          <div class="opt-chips" id="fen-chips">
            <div class="chip sel" onclick="sel(this)">å¹¿è¥¿ç±³ç²‰</div>
            <div class="chip" onclick="sel(this)">æ²³ç²‰</div>
          </div>
        </div>
        <div class="opt-grp" style="margin-top:10px">
          <div class="opt-title">ä»½é‡ <span class="req-tag">å¿…é€‰</span></div>
          <div class="opt-chips" id="amt-chips">
            <div class="chip" onclick="sel(this)">å°‘ç²‰</div>
            <div class="chip sel" onclick="sel(this)">æ­£å¸¸</div>
            <div class="chip" onclick="sel(this)">å¤šç²‰</div>
          </div>
        </div>
        <div class="opt-grp" style="margin-top:10px">
          <div class="opt-title">è¾£åº¦ <span class="req-tag">å¿…é€‰</span></div>
          <div class="opt-chips" id="la-chips">
            <div class="chip sel" onclick="sel(this)">å°è¾£</div>
            <div class="chip" onclick="sel(this)">ä¸­è¾£</div>
            <div class="chip" onclick="sel(this)">å¤§è¾£</div>
          </div>
        </div>
        <div class="opt-grp" style="margin-top:10px">
          <div class="opt-title">åŠ æ–™ <span class="opt-tag">ï¼ˆå¯å¤šé€‰ï¼Œä¸é€‰å³åŸå‘³ï¼›ç‚¹ï¼‹å¯å¤šä»½ï¼‰</span></div>
          <div class="topping-grid" id="topping-grid"></div>
        </div>
        <div class="opt-grp" style="margin-top:10px">
          <div class="opt-title">å…¶ä»–è¦æ±‚ <span class="opt-tag">ï¼ˆå»æ‰ä¸å–œæ¬¢çš„å°æ–™ï¼‰</span></div>
          <div class="opt-chips">
            <div class="chip multi" onclick="multiSel(this)">èµ°é…¸è±†è§’</div>
            <div class="chip multi" onclick="multiSel(this)">èµ°é…¸ç¬‹</div>
            <div class="chip multi" onclick="multiSel(this)">èµ°è…ç«¹</div>
            <div class="chip multi" onclick="multiSel(this)">èµ°æœ¨è€³ä¸</div>
            <div class="chip multi" onclick="multiSel(this)">èµ°èŠ±ç”Ÿç±³</div>
            <div class="chip multi" onclick="multiSel(this)">èµ°è‘±</div>
          </div>
        </div>
        <div class="opt-grp" style="margin-top:10px">
          <div class="opt-title">è·Ÿé¤ä¼˜æƒ  <span class="opt-tag">ï¼ˆå•é€‰ï¼Œä¼˜æƒ Â¥2ï¼‰</span></div>
          <div class="opt-chips" id="combo-chips"></div>
        </div>
        <div class="opt-grp" style="margin-top:10px">
          <div class="opt-title">å¤‡æ³¨ <span class="opt-tag">ï¼ˆæœ€å¤š50å­—ï¼‰</span></div>
          <textarea class="note-input" id="note-input" rows="2" maxlength="50"
            placeholder="ç‰¹æ®Šè¦æ±‚è¯·åœ¨æ­¤å¤‡æ³¨ï¼Œä¾‹å¦‚ï¼šå¤šç‚¹è‘±èŠ±â€¦"
            oninput="document.getElementById('note-cnt').textContent=this.value.length+'/50'"></textarea>
          <div class="note-counter" id="note-cnt">0/50</div>
        </div>
        <button class="confirm-btn" id="confirm-btn" onclick="confirmAdd()">åŠ å…¥è´­ç‰©è½¦ Â· Â¥10</button>
      </div>
    </div>
    <!-- CART SHEET -->
    <div class="ov" id="cart-sheet" onclick="maybeClose(event,'cart-sheet')">
      <div class="sheet">
        <div class="sheet-hd">
          <div class="sheet-title">è´­ç‰©è½¦</div>
          <button class="close-btn" onclick="closeSheet('cart-sheet')">âœ•</button>
        </div>
        <div style="padding:0 14px" id="cart-items-list"></div>
        <div class="cart-total-row">
          <span style="font-size:13px;color:#999">åˆè®¡</span>
          <span style="font-size:22px;font-weight:900;color:var(--red)" id="cart-sheet-total">Â¥0</span>
        </div>
        <button class="submit-btn" onclick="submitOrder()">ç¡®è®¤ä¸‹å•</button>
        <div style="font-size:10px;color:#bbb;text-align:center;margin-top:8px" id="net-status-customer"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• CUSTOMER ORDER PHONE â•â• -->
<div class="phone-wrap" id="view-order" style="display:none">
  <div class="phone-label">é¡¾å®¢ç«¯ Â· æˆ‘çš„è®¢å•</div>
  <div class="phone" style="display:flex;flex-direction:column;">
    <div id="order-status-container" style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
      <div style="flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;color:#bbb;padding:40px;">
        <div style="font-size:44px">ğŸ›’</div>
        <div style="font-size:13px;font-weight:600;">è¿˜æ²¡æœ‰è®¢å•</div>
        <div style="font-size:11px;text-align:center;line-height:1.7">å»ç‚¹é¤åä¸‹å•<br>è®¢å•çŠ¶æ€ä¼šåœ¨è¿™é‡Œå®æ—¶æ›´æ–°</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• MERCHANT PHONE â•â• -->
<div class="phone-wrap" id="view-merchant" style="display:none">
  <div class="phone-label">æ‘Šä¸»ç«¯ Â· ä»…æ‘Šä¸»å¯è§</div>
  <div class="phone" style="display:flex;flex-direction:column;">
    <!-- PRINT NOTIF -->
    <div class="pn" id="print-notif">
      <div style="font-size:20px;flex-shrink:0">ğŸ–¨ï¸</div>
      <div style="flex:1">
        <div style="font-size:11px;font-weight:700;" id="pn-text">æ–°è®¢å• Â· æ­£åœ¨æ‰“å°</div>
        <div style="font-size:9px;color:#aaa;margin-top:1px" id="pn-sub"></div>
        <div class="pn-bar"><div class="pn-fill" id="pn-fill"></div></div>
      </div>
    </div>
    <div class="m-header">
      <div><div class="m-title">å°è°¢èºè›³ç²‰ Â· å¤©ç©ºä¸€å·</div><div class="m-sub" id="biz-day-label">è¥ä¸šæ—¥ â€“</div></div>
      <div style="font-size:24px">ğŸ‘¨â€ğŸ³</div>
    </div>
    <div class="m-nav">
      <button class="m-nav-btn active" onclick="mNav(this,'m-orders')">ğŸ“‹ æ¥å•</button>
      <button class="m-nav-btn" onclick="mNav(this,'m-stats')">ğŸ“Š æŠ¥è¡¨</button>
      <button class="m-nav-btn" onclick="mNav(this,'m-menu')">ğŸœ èœå•</button>
    </div>

    <!-- ORDERS TAB -->
    <div id="m-orders" style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
      <div class="order-sub-nav">
        <button class="osn-btn active" id="osn-active" onclick="switchOrderTab('active',this)">è¿›è¡Œä¸­ <span id="osn-active-cnt"></span></button>
        <button class="osn-btn" id="osn-done" onclick="switchOrderTab('done',this)">å·²å®Œæˆ <span id="osn-done-cnt"></span></button>
      </div>
      <div class="date-filter" id="order-date-filter">
        <button class="df-btn active" onclick="setOrderDateFilter('today',this)">ä»Šæ—¥</button>
        <button class="df-btn" onclick="setOrderDateFilter('yesterday',this)">æ˜¨æ—¥</button>
        <button class="df-btn" onclick="setOrderDateFilter('2daysago',this)">å‰æ—¥</button>
        <button class="df-btn" onclick="setOrderDateFilter('range',this)">è‡ªå®šä¹‰åŒºé—´</button>
      </div>
      <div class="m-content" id="merchant-orders-list-container">
        <div class="orders-panel" id="merchant-orders-list"></div>
      </div>
    </div>

    <!-- STATS TAB -->
    <div id="m-stats" style="display:none;flex:1;overflow:hidden;flex-direction:column;display:none;">
      <div class="date-filter" id="stats-date-filter">
        <button class="df-btn active" onclick="setStatsFilter('bizday',this)">ä»Šæ—¥è¥ä¸šæ—¥</button>
        <button class="df-btn" onclick="setStatsFilter('yesterday',this)">æ˜¨æ—¥</button>
        <button class="df-btn" onclick="setStatsFilter('week',this)">æœ¬å‘¨</button>
        <button class="df-btn" onclick="setStatsFilter('month',this)">æœ¬æœˆ</button>
        <button class="df-btn" onclick="setStatsFilter('range',this)">è‡ªå®šä¹‰</button>
      </div>
      <div class="m-content">
        <div class="stats-section">
          <div class="stat-grid">
            <div class="stat-card wide" onclick="openStatDetail('revenue')">
              <div class="stat-label">è¥ä¸šé¢ <span id="stats-period-label" style="font-size:9px;opacity:0.7">(ä»Šæ—¥è¥ä¸šæ—¥)</span></div>
              <div class="stat-val" id="stat-revenue">Â¥0</div>
              <div class="stat-sub" id="stat-orders-sub">å…± 0 å•</div>
            </div>
            <div class="stat-card" onclick="openStatDetail('cash')">
              <div class="stat-label">ğŸ’µ ç°é‡‘</div>
              <div class="stat-val" style="font-size:18px" id="stat-cash">Â¥0</div>
              <div class="stat-sub">ç‚¹å‡»æŸ¥çœ‹æ˜ç»†</div>
            </div>
            <div class="stat-card" onclick="openStatDetail('digital')">
              <div class="stat-label">ğŸ“± å¾®ä¿¡/æ”¯ä»˜å®</div>
              <div class="stat-val" style="font-size:18px" id="stat-digital">Â¥0</div>
              <div class="stat-sub">ç‚¹å‡»æŸ¥çœ‹æ˜ç»†</div>
            </div>
            <div class="stat-card" onclick="openStatDetail('waive')" style="cursor:pointer">
              <div class="stat-label">ğŸ å…å•</div>
              <div class="stat-val" style="font-size:18px;color:var(--orange)" id="stat-waive">0å•</div>
              <div class="stat-sub">ç‚¹å‡»æŸ¥çœ‹æ˜ç»†</div>
            </div>
            <div class="stat-card" onclick="openStatDetail('profit')">
              <div class="stat-label">ğŸ’° åˆ©æ¶¦ä¼°ç®—</div>
              <div class="stat-val" style="font-size:18px;color:var(--green)" id="stat-profit">Â¥0</div>
              <div class="stat-sub">æˆæœ¬ç‡ 55%</div>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-title">â° é«˜å³°æ—¶æ®µ <a onclick="showToast('æ ¹æ®ç­›é€‰æ—¥æœŸåŠ¨æ€è®¡ç®—')">åŠ¨æ€</a></div>
            <div class="bar-chart" id="peak-chart"></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ğŸ† çƒ­å–æ’è¡Œ TOP10 <a onclick="openTopAll()">æŸ¥çœ‹å…¨éƒ¨</a></div>
            <div id="stats-top-items"></div>
          </div>
          <button class="dl-btn" onclick="downloadCSV()">â¬‡ï¸ ä¸‹è½½é”€å”®æ•°æ® Excel (CSV)</button>
        </div>
      </div>
    </div>

    <!-- MENU TAB -->
    <div id="m-menu" style="display:none;flex:1;overflow-y:auto;background:#f5f1ed;scrollbar-width:none;">
      <div style="padding:11px">
        <div style="background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.04);margin-bottom:9px">
          <div style="padding:10px 13px;border-bottom:1px solid #f5f5f5;display:flex;justify-content:space-between;align-items:center">
            <div style="font-size:12px;font-weight:700;color:var(--dark)">èœå“ç®¡ç†</div>
            <button onclick="openEdit(-1,true,'item')" style="background:var(--red);color:#fff;border:none;border-radius:7px;padding:4px 10px;font-size:10px;font-weight:600;cursor:pointer">+ æ·»åŠ </button>
          </div>
          <div id="menu-manage-list"></div>
        </div>
        <div style="background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.04)">
          <div style="padding:10px 13px;border-bottom:1px solid #f5f5f5"><div style="font-size:12px;font-weight:700;color:var(--dark)">æ‘Šä½è®¾ç½®</div></div>
          <div style="padding:10px 13px;display:flex;flex-direction:column;gap:11px">
            <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:11px;color:var(--dark)">ğŸ“ æ‘Šä½äºŒç»´ç </span><button style="background:var(--light);border:none;border-radius:6px;padding:4px 10px;font-size:10px;color:var(--mid);cursor:pointer;font-weight:600">ä¸‹è½½</button></div>
            <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:11px;color:var(--dark)">ğŸ–¨ï¸ æ‰“å°æœº</span><span style="font-size:10px;color:var(--green);font-weight:600">å·²è¿æ¥</span></div>
            <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:11px;color:var(--dark)">ğŸ”” è¥ä¸šçŠ¶æ€</span><div class="tog on" onclick="this.classList.toggle('on')"><div class="tog-knob"></div></div></div>
            <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:11px;color:var(--dark)">ğŸ•“ è¥ä¸šæ—¥ç»“ç®—æ—¶é—´</span><span style="font-size:10px;color:var(--blue);font-weight:600">å‡Œæ™¨ 4:00</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div class="pay-ov" id="pay-ov" onclick="maybeClosePay(event)">
      <div class="pay-sheet">
        <div class="pay-hd">
          <div class="pay-hd-title">ğŸ’° æ”¶æ¬¾ç¡®è®¤</div>
          <button class="close-btn" onclick="closePayModal()">âœ•</button>
        </div>
        <div class="pay-order-block">
          <div class="pay-order-num-lbl">è®¢å•å· <span id="pay-num-display">#0001</span></div>
          <div><span class="pay-yuan">Â¥</span><span class="pay-amount" id="pay-amount-display">0</span></div>
        </div>
        <div class="pay-method-title">é€‰æ‹©æ”¶æ¬¾æ–¹å¼</div>
        <div class="pay-methods">
          <div class="pmb" onclick="selPay(this,'cash')"><div class="pmb-icon">ğŸ’µ</div><div class="pmb-label">ç°é‡‘</div></div>
          <div class="pmb" onclick="selPay(this,'alipay')"><div class="pmb-icon">ğŸ”µ</div><div class="pmb-label">æ”¯ä»˜å®</div></div>
          <div class="pmb" onclick="selPay(this,'wechat')"><div class="pmb-icon">ğŸ’š</div><div class="pmb-label">å¾®ä¿¡æ”¯ä»˜</div></div>
          <div class="pmb waive" onclick="selPay(this,'waive')"><div class="pmb-icon">ğŸ</div><div class="pmb-label">å…å•</div></div>
        </div>
        <div class="waive-rs" id="waive-rs">
          <div style="font-size:10px;color:#aaa;margin-bottom:2px">é€‰æ‹©å…å•/å–æ¶ˆç†ç”±</div>
          <div class="wr-btn" onclick="selWaive(this,'å‡ºé”™è¡¥å¿')">â‘  å‡ºé”™è¡¥å¿</div>
          <div class="wr-btn" onclick="selWaive(this,'ç»è¥æ¨å¹¿')">â‘¡ ç»è¥æ¨å¹¿</div>
          <div class="wr-btn" onclick="selWaive(this,'äººæƒ…å…³ç³»')">â‘¢ äººæƒ…å…³ç³»</div>
          <div class="wr-btn" onclick="selWaive(this,'å–æ¶ˆè®¢å•')">â‘£ å–æ¶ˆè®¢å•</div>
        </div>
        <button class="pay-confirm" id="pay-confirm-btn" onclick="completePay()" disabled>ç¡®è®¤æ”¶æ¬¾</button>
      </div>
    </div>

    <!-- CONFIRM DIALOG (reprint) -->
    <div class="ov center" id="confirm-dlg-ov" onclick="maybeClose(event,'confirm-dlg-ov')">
      <div class="confirm-dlg">
        <div class="cdlg-icon">ğŸ–¨ï¸</div>
        <div class="cdlg-title">äºŒæ¬¡æ‰“å°ç¡®è®¤</div>
        <div class="cdlg-sub">æ­¤è®¢å•å·²æ‰“å°è¿‡ä¸€æ¬¡ã€‚<br>ç¡®è®¤è¦<b>é‡æ–°æ‰“å°</b>å—ï¼Ÿ<br>è¯·é¿å…é‡å¤å‡ºé¤ã€‚</div>
        <div class="cdlg-btns">
          <button class="cdlg-btn cancel" onclick="closeSheet('confirm-dlg-ov')">å–æ¶ˆ</button>
          <button class="cdlg-btn confirm" onclick="doReprint()">ç¡®è®¤æ‰“å°</button>
        </div>
      </div>
    </div>

    <!-- STAT DETAIL SHEET -->
    <div class="ov" id="stat-detail-ov" onclick="maybeClose(event,'stat-detail-ov')">
      <div class="sheet">
        <div class="sheet-hd">
          <div class="sheet-title" id="stat-detail-title">æ˜ç»†</div>
          <button class="close-btn" onclick="closeSheet('stat-detail-ov')">âœ•</button>
        </div>
        <div style="padding:0 14px 14px" id="stat-detail-content"></div>
      </div>
    </div>

    <!-- TOP ALL SHEET -->
    <div class="ov" id="top-all-ov" onclick="maybeClose(event,'top-all-ov')">
      <div class="sheet">
        <div class="sheet-hd">
          <div class="sheet-title">å…¨éƒ¨çƒ­å–æ’è¡Œ</div>
          <button class="close-btn" onclick="closeSheet('top-all-ov')">âœ•</button>
        </div>
        <div style="padding:0 14px 14px" id="top-all-content"></div>
      </div>
    </div>

    <!-- EDIT MODAL -->
    <div class="edit-ov" id="edit-ov" onclick="maybeCloseEdit(event)">
      <div class="edit-modal">
        <h3 id="edit-title">ç¼–è¾‘èœå“</h3>
        <div class="ef"><div class="ef-label">åç§°</div><input class="ef-input" id="edit-name" placeholder="åç§°"></div>
        <div class="ef"><div class="ef-label">ä»·æ ¼ï¼ˆå…ƒï¼‰</div><input class="ef-input" id="edit-price" type="number" placeholder="ä»·æ ¼"></div>
        <div class="ef" id="edit-cat-row"><div class="ef-label">åˆ†ç±»</div>
          <select class="ef-input" id="edit-cat">
            <option value="noodles">èºè›³ç²‰</option>
            <option value="drinks">é¥®æ–™</option>
            <option value="dessert">ç”œå“</option>
          </select>
        </div>
        <div class="ef" style="display:flex;align-items:center;justify-content:space-between">
          <div class="ef-label" style="margin:0">æ˜¯å¦ä¸Šæ¶</div>
          <div class="tog on" id="edit-tog" onclick="this.classList.toggle('on')"><div class="tog-knob"></div></div>
        </div>
        <div class="ef-row">
          <button class="ef-cancel" onclick="closeEdit()">å–æ¶ˆ</button>
          <button class="ef-save" onclick="saveEdit()">ä¿å­˜</button>
        </div>
      </div>
    </div>

  </div><!-- end merchant phone -->
</div>

</div><!-- end phones-row -->
<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS & CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STORE = {id:'001', name:'å°è°¢èºè›³ç²‰', branch:'å¤©ç©ºä¸€å·å…¬å¯“åº—', table:'08'};
const BIZ_DAY_CUTOFF_HOUR = 4; // before 4am = previous biz day

function getBizDay(date = new Date()) {
  const d = new Date(date);
  if (d.getHours() < BIZ_DAY_CUTOFF_HOUR) d.setDate(d.getDate() - 1);
  return d.toISOString().split('T')[0]; // YYYY-MM-DD
}

function fmtDate(d) {
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATABASE (in-memory, simulates persistent storage)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB = {
  items:[
    {id:1,cat:'noodles',name:'æ‹›ç‰Œèºè›³ç²‰',desc:'æ­£å®—æŸ³å·ç§˜åˆ¶èºè›³æ±¤åº•',price:10,on:true,hot:true},
    {id:2,cat:'noodles',name:'å¹²æ‹Œèºè›³ç²‰',desc:'å»æ±¤æ‹Œæ–™ï¼Œå£æ„Ÿæµ“éƒ',price:10,on:true,hot:false},
    {id:3,cat:'drinks',name:'å¯ä¹ï¼ˆç½ï¼‰',desc:'',price:4,on:false,hot:false},
    {id:4,cat:'drinks',name:'é›ªç¢§ï¼ˆç½ï¼‰',desc:'',price:4,on:false,hot:false},
    {id:5,cat:'drinks',name:'ç‹è€å‰ï¼ˆç½ï¼‰',desc:'',price:5,on:false,hot:false},
    {id:6,cat:'drinks',name:'ç™¾å¨ï¼ˆç½ï¼‰',desc:'',price:7,on:false,hot:false},
    {id:7,cat:'drinks',name:'çº¯ç”Ÿï¼ˆç½ï¼‰',desc:'',price:6,on:false,hot:false},
    {id:8,cat:'drinks',name:'å†œå¤«å±±æ³‰ï¼ˆæ”¯ï¼‰',desc:'',price:2,on:false,hot:false},
    {id:9,cat:'dessert',name:'å†°é•‡ç»¿è±†æ²™',desc:'æ¸…çƒ­æ¶ˆæš‘',price:6,on:false,hot:false},
    {id:10,cat:'dessert',name:'æœ¨è–¯ç³–æ°´',desc:'è½¯ç³¯é¦™ç”œ',price:9,on:false,hot:false},
  ],
  toppings:[
    {id:'t1',name:'ğŸ· è™çš®çŒªè„š',price:10,on:true},
    {id:'t2',name:'ğŸ— å¤é¸¡è…¿',price:5,on:true},
    {id:'t3',name:'ğŸ¦† å¤é¸­è…¿',price:5,on:true},
    {id:'t4',name:'ğŸ¥© çŒªçš®',price:5,on:true},
    {id:'t5',name:'ğŸ¥© çƒ§è‚‰',price:5,on:true},
    {id:'t6',name:'ğŸ¦¶ è™çš®é¸¡çˆª',price:4,on:true},
    {id:'t7',name:'ğŸ¥š ç‚¸è›‹',price:3,on:true},
    {id:'t8',name:'ğŸŒ­ è…Šè‚ ',price:3,on:true},
    {id:'t9',name:'ğŸ¥© ç‰›è‚‰ä¸¸',price:3,on:true},
    {id:'t10',name:'ğŸ¦† è™çš®é¸­çˆª',price:3,on:true},
    {id:'t11',name:'ğŸŒ­ é¦™è‚ ',price:2,on:true},
    {id:'t12',name:'ğŸ«˜ å¤è±†æ³¡',price:2,on:true},
    {id:'t13',name:'ğŸ¢ å¤è±†è…ä¸²',price:2,on:true},
    {id:'t14',name:'ğŸ¥š ç…è›‹',price:2,on:true},
    {id:'t15',name:'ğŸ„ æœ¨è€³ä¸',price:2,on:true},
    {id:'t16',name:'ğŸ«˜ è…ç«¹',price:2,on:true},
    {id:'t17',name:'ğŸ¥¬ é€šèœ',price:2,on:true},
    {id:'t18',name:'ğŸŒ¶ é…¸è±†è§’',price:1,on:true},
    {id:'t19',name:'ğŸ‹ é…¸ç¬‹',price:1,on:true},
  ],
  CL:{noodles:'èºè›³ç²‰',drinks:'é¥®æ–™',dessert:'ç”œå“'},
  CE:{noodles:'ğŸœ',drinks:'ğŸ¥¤',dessert:'ğŸµ'},
  cats(){return [...new Set(this.items.map(i=>i.cat))]},
  nextId(){return Math.max(0,...this.items.map(i=>i.id))+1},
  nextTopId(){const ns=this.toppings.map(t=>parseInt(t.id.replace('t',''))).filter(n=>!isNaN(n));return 't'+(Math.max(0,...ns)+1);},
  activeDesserts(){return this.items.filter(i=>i.cat==='dessert'&&i.on)},
  activeToppings(){return this.toppings.filter(t=>t.on)},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORDER STATE & ID GENERATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let orders = []; // all orders this session
let orderSeq = 0; // daily sequence counter (per biz day)
let lastBizDay = getBizDay();
let customerLatestOrder = null; // for customer view

function genOrderId() {
  const bday = getBizDay();
  if (bday !== lastBizDay) { orderSeq = 0; lastBizDay = bday; }
  orderSeq++;
  const fullId = fmtDate(new Date()).replace(/(\d{4})(\d{2})(\d{2})/,'$1$2$3') + String(orderSeq).padStart(4,'0');
  const displayNum = String(orderSeq).padStart(4,'0');
  return {fullId, displayNum};
}

function updateBizDayLabel() {
  const bd = getBizDay();
  document.getElementById('biz-day-label').textContent = `è¥ä¸šæ—¥ ${bd}ï¼ˆæˆªè‡³å‡Œæ™¨4æ—¶ï¼‰`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NETWORK SIMULATION (for prototype)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let netOk = true;
function simNetCheck() {
  // In real app: actual fetch ping to server
  // For prototype: simulate 97% success rate
  netOk = Math.random() > 0.03;
  const dot = document.getElementById('sync-dot');
  if(dot) dot.className = 'sync-dot' + (netOk ? '' : ' error');
  return netOk;
}
// Simulated real-time "push" - poll every 2s
setInterval(() => {
  simNetCheck();
  // In real app: WebSocket would push order updates here
}, 2000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let cart = [];
function cartTotal(){return cart.reduce((s,l)=>s+l.lineTotal,0);}
function cartCount(){return cart.reduce((s,l)=>s+l.qty,0);}
function updateCartBar(){
  const cnt=cartCount(), tot=cartTotal();
  const bar=document.getElementById('cart-bar');
  document.getElementById('cart-badge').textContent=cnt;
  document.getElementById('cart-total-disp').textContent='Â¥'+tot;
  bar.classList.toggle('empty', cnt===0);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER ALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAll(){
  renderCustomerMenu();
  renderToppings();
  renderCombo();
  renderMenuManage();
  renderStats();
  renderMerchantOrders();
  updateCartBar();
  updateBizDayLabel();
}

/* â”€â”€ CUSTOMER MENU â”€â”€ */
function renderCustomerMenu(){
  const cats=DB.cats();
  document.getElementById('customer-cat-tabs').innerHTML=cats.map((c,i)=>
    `<div class="cat-tab${i===0?' active':''}" onclick="switchCat(this,'ccat-${c}')">${DB.CL[c]}</div>`
  ).join('');
  document.getElementById('customer-menu-list').innerHTML=cats.map((c,ci)=>{
    const its=[...DB.items.filter(i=>i.cat===c)].sort((a,b)=>b.on-a.on);
    return `<div id="ccat-${c}"${ci>0?' style="display:none"':''}>
      <div class="menu-section-title">${DB.CL[c]}</div>
      ${its.map(item=>{
        const so=!item.on;
        const fn=item.cat==='noodles'?`openModal(${item.id})`:`quickAdd(${item.id})`;
        return `<div class="menu-item${so?' soldout-item':''}"${!so?` onclick="${fn}"`:''}>
          <div class="item-emoji">${DB.CE[item.cat]}</div>
          <div class="item-info">
            <div class="item-name">${item.name}</div>
            <div class="item-desc">${item.desc}</div>
            ${item.cat==='noodles'?'<div class="item-small">å°æ–™ï¼šé…¸è±†è§’ã€é…¸ç¬‹ã€è…ç«¹ã€æœ¨è€³ä¸ã€èŠ±ç”Ÿç±³ã€è‘±</div>':''}
            <div class="item-tags">
              ${item.hot?'<span class="item-tag hot">ğŸ”¥ çƒ­é”€</span>':''}
              ${item.cat==='noodles'?'<span class="item-tag">è¾£åº¦å¯è°ƒ</span>':''}
              ${so?'<span class="item-tag" style="background:#f0f0f0;color:#aaa">ä¼°æ¸…</span>':''}
            </div>
          </div>
          <div class="item-price-add">
            <div class="item-price${so?' soldout':''}">Â¥${item.price}${item.cat==='noodles'?'èµ·':''}</div>
            ${so?'<div class="soldout-badge">ä¼°æ¸…</div>':`<button class="add-btn" onclick="${fn};event.stopPropagation()">+</button>`}
          </div>
        </div>`;
      }).join('')}
    </div>`;
  }).join('');
}

/* â”€â”€ TOPPINGS WITH QTY â”€â”€ */
// toppingQtys: {id: qty}
let toppingQtys = {};
function renderToppings(){
  const tops=DB.activeToppings();
  toppingQtys={};
  document.getElementById('topping-grid').innerHTML=tops.length===0
    ?'<div style="grid-column:span 2;font-size:11px;color:#bbb;padding:6px 0">æš‚æ— å¯ç”¨é…æ–™</div>'
    :tops.map(t=>`
      <div class="top-item" id="ti-${t.id}">
        <span class="top-name">${t.name}</span>
        <div class="top-right">
          <span class="top-price">+Â¥${t.price}</span>
          <div class="top-qty-ctrl" id="tqc-${t.id}">
            <button class="tqb plus-only" onclick="topQtyChange('${t.id}',${t.price},1)">+</button>
          </div>
        </div>
      </div>`).join('');
}

function topQtyChange(tid, price, delta){
  toppingQtys[tid] = Math.max(0, (toppingQtys[tid]||0) + delta);
  const qty = toppingQtys[tid];
  const ctrl = document.getElementById('tqc-'+tid);
  const item = document.getElementById('ti-'+tid);
  if(qty===0){
    ctrl.innerHTML=`<button class="tqb plus-only" onclick="topQtyChange('${tid}',${price},1)">+</button>`;
    item.classList.remove('has-qty');
  } else {
    ctrl.innerHTML=`<button class="tqb minus" onclick="topQtyChange('${tid}',${price},-1)">âˆ’</button>
      <span class="tqb-num">${qty}</span>
      <button class="tqb plus" onclick="topQtyChange('${tid}',${price},1)">+</button>`;
    item.classList.add('has-qty');
  }
  recalc();
}

/* â”€â”€ COMBO â”€â”€ */
function renderCombo(){
  const active=DB.activeDesserts();
  const el=document.getElementById('combo-chips');
  if(!el)return;
  el.innerHTML=active.length===0
    ?'<div class="chip disabled">æš‚æ— å¯è·Ÿé¤ç”œå“ï¼ˆä¼°æ¸…ä¸­ï¼‰</div>'
    :active.map(d=>`<div class="chip combo" onclick="selCombo(this,${d.price})">${d.name} Â¥${d.price-2}</div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentId=null, extraPrice=0, comboDiscount=0;

function openModal(id){
  currentId=id; extraPrice=0; comboDiscount=0;
  const item=DB.items.find(i=>i.id===id);
  document.getElementById('modal-item-name').textContent=item.name;
  document.querySelectorAll('#fen-chips .chip').forEach((c,i)=>c.classList.toggle('sel',i===0));
  document.querySelectorAll('#amt-chips .chip').forEach((c,i)=>c.classList.toggle('sel',i===1));
  document.querySelectorAll('#la-chips .chip').forEach((c,i)=>c.classList.toggle('sel',i===0));
  document.querySelectorAll('.chip.multi').forEach(c=>c.classList.remove('sel'));
  document.querySelectorAll('.chip.combo').forEach(c=>c.classList.remove('sel'));
  document.getElementById('note-input').value='';
  document.getElementById('note-cnt').textContent='0/50';
  renderToppings(); renderCombo(); recalc();
  openSheet('modal');
}

function recalc(){
  const item=DB.items.find(i=>i.id===currentId);
  if(!item)return;
  let topExtra=0;
  DB.activeToppings().forEach(t=>{const q=toppingQtys[t.id]||0;topExtra+=q*t.price;});
  extraPrice=topExtra;
  const t=item.price+extraPrice-comboDiscount;
  document.getElementById('modal-price').textContent='Â¥'+t;
  document.getElementById('confirm-btn').textContent='åŠ å…¥è´­ç‰©è½¦ Â· Â¥'+t;
}

function sel(el){el.closest('.opt-chips').querySelectorAll('.chip').forEach(c=>c.classList.remove('sel'));el.classList.add('sel');}
function multiSel(el){el.classList.toggle('sel');}
function selCombo(el,op){
  const was=el.classList.contains('sel');
  document.querySelectorAll('#combo-chips .chip.combo').forEach(c=>c.classList.remove('sel'));
  comboDiscount=0;
  if(!was){el.classList.add('sel');comboDiscount=2;}
  recalc();
}

function confirmAdd(){
  const item=DB.items.find(i=>i.id===currentId);
  const unitPrice=item.price+extraPrice-comboDiscount;
  const fen=[...document.querySelectorAll('#fen-chips .chip.sel')].map(c=>c.textContent).join('');
  const amt=[...document.querySelectorAll('#amt-chips .chip.sel')].map(c=>c.textContent).join('');
  const la=[...document.querySelectorAll('#la-chips .chip.sel')].map(c=>c.textContent).join('');
  const tops=[];
  DB.activeToppings().forEach(t=>{const q=toppingQtys[t.id]||0;if(q>0)tops.push({name:t.name,qty:q,unitPrice:t.price});});
  const excludes=[...document.querySelectorAll('.chip.multi.sel')].map(c=>c.textContent).join('ã€');
  const combo=[...document.querySelectorAll('#combo-chips .chip.sel')].map(c=>c.textContent).join('');
  const note=document.getElementById('note-input').value.trim();

  // Build structured spec for receipt
  const specParts=[`${fen}Â·${amt}Â·${la}`];
  if(tops.length) tops.forEach(t=>specParts.push(`åŠ  ${t.name}Ã—${t.qty}(+Â¥${t.unitPrice*t.qty})`));
  if(excludes) specParts.push(excludes);
  if(combo) specParts.push(`è·Ÿé¤ï¼š${combo}`);
  if(note) specParts.push(`å¤‡æ³¨ï¼š${note}`);
  const spec=specParts.join('\n');

  cart.push({itemId:item.id,name:item.name,spec,toppings:tops,unitPrice,qty:1,lineTotal:unitPrice});
  updateCartBar(); closeSheet('modal'); showToast('âœ… å·²åŠ å…¥è´­ç‰©è½¦ï¼');
}

function quickAdd(id){
  const item=DB.items.find(i=>i.id===id);
  if(!item||!item.on)return;
  cart.push({itemId:id,name:item.name,spec:'',toppings:[],unitPrice:item.price,qty:1,lineTotal:item.price});
  updateCartBar(); showToast(`âœ… å·²åŠ å…¥ï¼š${item.name} Â¥${item.price}`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CART SHEET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openCartSheet(){
  if(cartCount()===0)return;
  renderCartSheet(); openSheet('cart-sheet');
}
function renderCartSheet(){
  const el=document.getElementById('cart-items-list');
  el.innerHTML=cart.map((line,idx)=>`
    <div class="csi">
      <div class="csi-info">
        <div class="csi-name">${line.name}</div>
        ${line.spec?`<div class="csi-spec">${line.spec.replace(/\n/g,'<br>')}</div>`:''}
      </div>
      <div class="csi-price">Â¥${line.lineTotal}</div>
      <div class="qty-ctrl">
        <button class="qb minus" onclick="changeQty(${idx},-1)">âˆ’</button>
        <span class="qb-num">${line.qty}</span>
        <button class="qb plus" onclick="changeQty(${idx},1)">+</button>
      </div>
    </div>`).join('');
  document.getElementById('cart-sheet-total').textContent='Â¥'+cartTotal();
}
function changeQty(idx,delta){
  if(!cart[idx])return;
  cart[idx].qty+=delta;
  if(cart[idx].qty<=0) cart.splice(idx,1);
  else cart[idx].lineTotal=cart[idx].unitPrice*cart[idx].qty;
  updateCartBar();
  if(cart.length===0){closeSheet('cart-sheet');return;}
  renderCartSheet();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORDER SUBMIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function submitOrder(){
  if(cart.length===0)return;
  // Network check
  if(!simNetCheck()){
    document.getElementById('net-status-customer').textContent='âš ï¸ ç½‘ç»œå¼‚å¸¸ï¼Œä¸‹å•å¤±è´¥ï¼è¯·é‡è¯•';
    document.getElementById('net-status-customer').style.color='var(--red)';
    showToast('âŒ ç½‘ç»œå¼‚å¸¸ï¼Œä¸‹å•æœªæˆåŠŸï¼Œè¯·é‡è¯•ï¼');
    return;
  }
  document.getElementById('net-status-customer').textContent='';

  const {fullId, displayNum} = genOrderId();
  const total = cartTotal();
  const lines = [...cart];
  cart = [];
  updateCartBar();
  closeSheet('cart-sheet');

  const order = {
    fullId, displayNum,
    storeId: STORE.id, storeName: STORE.name, branch: STORE.branch,
    lines, total,
    status: 'making',
    bizDay: getBizDay(),
    time: new Date(),
    printed: false,
    payMethod: null, waiveReason: null,
  };
  orders.unshift(order);
  customerLatestOrder = order;

  // Sync customer order view
  renderCustomerOrderView(order);
  // Sync merchant
  renderMerchantOrders();
  // Trigger print
  triggerPrint(order);

  // Switch to order tab
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-btn')[1].classList.add('active');
  showTab('order', null);
  showToast(`ğŸ‰ ä¸‹å•æˆåŠŸï¼å–é¤å· #${displayNum}`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CUSTOMER ORDER VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderCustomerOrderView(order){
  if(!order) return;
  const container=document.getElementById('order-status-container');
  const hdrClass={making:'making',ready:'ready',paid:'paid'}[order.status]||'making';
  const statusLabel={making:'åˆ¶ä½œä¸­',ready:'è¯·å–é¤å¹¶ä»˜æ¬¾',paid:'å·²å®Œæˆ'}[order.status];
  const steps=[
    {done:true,active:false,icon:'âœ“',name:'ä¸‹å•æˆåŠŸ',sub:'å°ç¥¨å·²è‡ªåŠ¨æ‰“å°'},
    {done:order.status!=='making',active:order.status==='making',icon:'ğŸœ',name:'åˆ¶ä½œä¸­',sub:'æ‘Šä¸»æ­£åœ¨ä¸ºä½ åˆ¶ä½œ'},
    {done:['ready','paid'].includes(order.status),active:order.status==='ready',icon:'ğŸ””',name:'è¯·å–é¤',sub:order.status==='ready'?'ğŸ‰ ä½ çš„é¤å¥½äº†ï¼è¯·å‡­å·å–é¤ä»˜æ¬¾':'â€“'},
    {done:order.status==='paid',active:false,icon:'ğŸ’°',name:'ä»˜æ¬¾å®Œæˆ',sub:order.status==='paid'?`å·²${({cash:'ç°é‡‘',alipay:'æ”¯ä»˜å®',wechat:'å¾®ä¿¡',waive:'å…å•'}[order.payMethod]||'')}ç»“æ¸…`:'â€“'},
  ];
  container.innerHTML=`
    <div class="os-hd ${hdrClass}" style="flex-shrink:0">
      <div class="os-num-label">ä½ çš„å–é¤å·</div>
      <div class="os-big-num">#${order.displayNum}</div>
      <div class="os-pill"><div class="os-dot"></div>${statusLabel}</div>
    </div>
    <div class="os-body">
      ${order.status==='ready'?`
      <div class="pay-prompt">
        <div class="pp-title">ğŸ‰ ä½ çš„é¤å¥½äº†ï¼è¯·åˆ° 06å·æ‘Š å–é¤å¹¶ä»˜æ¬¾</div>
        <div class="pp-price">Â¥${order.total}</div>
        <div class="pp-sub">å‘æ‘Šä¸»æŠ¥å‡ºå–é¤å· #${order.displayNum}</div>
      </div>`:''}
      <div class="os-card">
        <div class="os-card-title">ğŸ“¦ è®¢å•è¿›åº¦</div>
        ${steps.map((s,i)=>`<div class="os-step">
          <div class="os-step-left">
            <div class="os-circle ${s.done?'done':s.active?'active':'pending'}">${s.done?'âœ“':s.icon}</div>
            ${i<steps.length-1?`<div class="os-line ${s.done?'done':''}"></div>`:''}
          </div>
          <div class="os-step-info" style="${i===steps.length-1?'padding-bottom:0':''}">
            <div class="os-step-name">${s.name}</div>
            <div class="os-step-sub">${s.sub}</div>
          </div>
        </div>`).join('')}
      </div>
      <div class="os-card">
        <div class="os-card-title">ğŸ§¾ æœ¬æ¬¡è®¢å• Â· #${order.displayNum}</div>
        ${order.lines.map(l=>`
          <div style="padding:6px 0;border-bottom:1px solid #f5f5f5">
            <div style="display:flex;justify-content:space-between">
              <span style="font-size:12px;font-weight:700;color:var(--dark)">${l.name} Ã—${l.qty}</span>
              <span style="font-size:13px;font-weight:700;color:var(--red)">Â¥${l.lineTotal}</span>
            </div>
            ${l.spec?`<div style="font-size:10px;color:#999;margin-top:2px;white-space:pre-line">${l.spec}</div>`:''}
          </div>`).join('')}
        <div style="display:flex;justify-content:space-between;padding-top:9px;margin-top:2px">
          <span style="font-size:12px;font-weight:700">åˆè®¡</span>
          <span style="font-size:15px;font-weight:900;color:var(--red)">Â¥${order.total}</span>
        </div>
      </div>
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MERCHANT ORDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let orderTab = 'active'; // 'active' | 'done'
let orderDateFilter = 'today';

function switchOrderTab(tab, btn){
  orderTab = tab;
  document.querySelectorAll('.osn-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  // show date filter only for done tab
  document.getElementById('order-date-filter').style.display = tab==='done' ? 'flex' : 'none';
  renderMerchantOrders();
}

function setOrderDateFilter(f, btn){
  orderDateFilter = f;
  document.querySelectorAll('#order-date-filter .df-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderMerchantOrders();
}

function renderMerchantOrders(){
  const el = document.getElementById('merchant-orders-list');
  const bizToday = getBizDay();
  const bizYesterday = getBizDay(new Date(Date.now() - 86400000));
  const biz2daysago = getBizDay(new Date(Date.now() - 2*86400000));

  const active = orders.filter(o=>o.status!=='paid');
  const done = orders.filter(o=>o.status==='paid');

  // Update tab counters
  document.getElementById('osn-active-cnt').textContent = active.length ? `(${active.length})` : '';
  document.getElementById('osn-done-cnt').textContent = done.length ? `(${done.length})` : '';

  if(orderTab==='active'){
    if(active.length===0){
      el.innerHTML=`<div style="text-align:center;padding:36px 18px;color:#bbb"><div style="font-size:34px;margin-bottom:8px">ğŸ“‹</div><div style="font-size:12px">æš‚æ— è¿›è¡Œä¸­è®¢å•</div></div>`;
      return;
    }
    el.innerHTML=active.map(o=>merchantCard(o)).join('');
  } else {
    // done tab with date filter
    let filtered = done;
    if(orderDateFilter==='today') filtered = done.filter(o=>o.bizDay===bizToday);
    else if(orderDateFilter==='yesterday') filtered = done.filter(o=>o.bizDay===bizYesterday);
    else if(orderDateFilter==='2daysago') filtered = done.filter(o=>o.bizDay===biz2daysago);
    // 'range' would open a date picker in real app

    if(filtered.length===0){
      el.innerHTML=`<div style="text-align:center;padding:36px 18px;color:#bbb"><div style="font-size:34px;margin-bottom:8px">âœ…</div><div style="font-size:12px">è¯¥æ—¥æœŸæ— å®Œæˆè®¢å•</div></div>`;
      return;
    }
    // Group by bizDay
    const byDay = {};
    filtered.forEach(o=>{(byDay[o.bizDay]||(byDay[o.bizDay]=[])).push(o);});
    el.innerHTML=Object.keys(byDay).sort().reverse().map(day=>{
      const dayOrders = byDay[day];
      const dayRev = dayOrders.filter(o=>o.payMethod!=='waive').reduce((s,o)=>s+o.total,0);
      return `<div class="sec-head"><div class="sec-title">è¥ä¸šæ—¥ ${day}</div><div style="font-size:10px;color:#999">${dayOrders.length}å• Â· Â¥${dayRev}</div></div>`
        + dayOrders.map(o=>merchantCard(o)).join('');
    }).join('');
  }
}

let reprintTarget = null;

function merchantCard(o){
  const badgeClass={making:'making',ready:'ready',paid:'paid'}[o.status];
  const badgeLabel={making:'ğŸœ åˆ¶ä½œä¸­',ready:'ğŸ”” ç­‰å¾…å–é¤',paid:'âœ… å·²å®Œæˆ'}[o.status];
  const t=o.time;
  const tStr=`${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
  // Build receipt lines
  const receiptHtml = o.lines.map(l=>`
    <div class="receipt-line" style="font-weight:700;font-size:12px">
      <span>ğŸ“Œ ${l.name} Ã—${l.qty}</span><span>Â¥${l.lineTotal}</span>
    </div>
    ${l.toppings&&l.toppings.length?l.toppings.map(tp=>`
      <div class="receipt-line" style="padding-left:12px">
        <span>ï¼‹${tp.name} Ã—${tp.qty}</span><span>Â¥${tp.unitPrice*tp.qty}</span>
      </div>`).join(''):''}
    ${l.spec?l.spec.split('\n').filter(s=>!s.startsWith('åŠ ')).filter(s=>s).map(s=>`
      <div class="receipt-spec">Â· ${s}</div>`).join(''):''}
  `).join('');

  // Preview (first line only)
  const preview = o.lines.map(l=>l.name+'Ã—'+l.qty).join('ã€');

  let actions='';
  if(o.status==='making'){
    actions=`<div class="mc-actions"><button class="abtn green" onclick="markReady('${o.fullId}');event.stopPropagation()">âœ… åšå¥½äº† Â· å«å·å–é¤</button></div>`;
  } else if(o.status==='ready'){
    actions=`<div class="mc-actions">
      <button class="abtn sec" onclick="callAgain('${o.displayNum}');event.stopPropagation()">ğŸ“¢ å†å«</button>
      <button class="abtn orange" onclick="openPayModal('${o.fullId}');event.stopPropagation()">ğŸ’° æ”¶æ¬¾</button>
    </div>`;
  } else {
    const pl={cash:'ç°é‡‘',alipay:'æ”¯ä»˜å®',wechat:'å¾®ä¿¡',waive:`å…å•Â·${o.waiveReason}`}[o.payMethod]||'';
    actions=`<div style="font-size:10px;color:#bbb;padding:0 13px 9px">ğŸ’³ ${pl}</div>`;
  }

  return `<div class="mc">
    <div class="mc-top" onclick="toggleDetail('${o.fullId}')">
      <div class="mc-left">
        <div class="mc-num">#${o.displayNum}</div>
        <div class="mc-time">${tStr} Â· è¥ä¸šæ—¥ ${o.bizDay}</div>
      </div>
      <div class="mc-right">
        <div class="mc-price">Â¥${o.total}</div>
        <div class="mc-badge ${badgeClass}">${badgeLabel}</div>
      </div>
    </div>
    <div class="mc-preview">${preview} Â· ç‚¹å‡»å±•å¼€è¯¦æƒ… â–¾</div>
    <div class="mc-detail" id="detail-${o.fullId}">
      <div class="mc-detail-title">ğŸ§¾ è®¢å•è¯¦æƒ…ï¼ˆå®Œæ•´å°ç¥¨ï¼‰</div>
      <div class="receipt">
        <div style="font-size:10px;color:#aaa;margin-bottom:6px">è®¢å•å·ï¼š${o.fullId} Â· ${tStr}</div>
        ${receiptHtml}
        <div class="receipt-line total"><span>åˆè®¡</span><span>Â¥${o.total}</span></div>
      </div>
      <div class="mc-reprint" onclick="askReprint('${o.fullId}')">ğŸ–¨ï¸ é‡æ–°æ‰“å°æ­¤è®¢å•</div>
    </div>
    ${actions}
  </div>`;
}

function toggleDetail(fullId){
  const el = document.getElementById('detail-'+fullId);
  if(!el)return;
  el.classList.toggle('open');
}

function askReprint(fullId){
  reprintTarget = fullId;
  openSheet('confirm-dlg-ov');
}
function doReprint(){
  const o = orders.find(o=>o.fullId===reprintTarget);
  if(o){ triggerPrint(o, true); }
  closeSheet('confirm-dlg-ov');
  showToast('ğŸ–¨ï¸ é‡æ–°æ‰“å°ä¸­â€¦');
}

/* â”€â”€ MARK READY â”€â”€ */
function markReady(fullId){
  const o=orders.find(o=>o.fullId===fullId);
  if(!o)return;
  o.status='ready';
  renderMerchantOrders();
  if(customerLatestOrder&&customerLatestOrder.fullId===fullId) renderCustomerOrderView(o);
  showToast(`ğŸ“¢ #${o.displayNum} å·²å«å·ï¼è¯·é¡¾å®¢å–é¤ä»˜æ¬¾`);
}
function callAgain(num){ showToast(`ğŸ“¢ ${num}å·ï¼${num}å·é¡¾å®¢è¯·å–é¤ï¼`);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAYMENT MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let payingFullId=null, selPayMethod=null, selWaiveReason=null;
function openPayModal(fullId){
  const o=orders.find(o=>o.fullId===fullId);
  if(!o)return;
  payingFullId=fullId; selPayMethod=null; selWaiveReason=null;
  document.getElementById('pay-num-display').textContent='#'+o.displayNum;
  document.getElementById('pay-amount-display').textContent=o.total;
  document.querySelectorAll('.pmb').forEach(b=>b.classList.remove('sel'));
  document.querySelectorAll('.wr-btn').forEach(b=>b.classList.remove('sel'));
  document.getElementById('waive-rs').classList.remove('show');
  document.getElementById('pay-confirm-btn').disabled=true;
  document.getElementById('pay-ov').classList.add('show');
}
function closePayModal(){document.getElementById('pay-ov').classList.remove('show');}
function maybeClosePay(e){if(e.target.id==='pay-ov')closePayModal();}
function selPay(el,method){
  document.querySelectorAll('.pmb').forEach(b=>b.classList.remove('sel'));
  el.classList.add('sel'); selPayMethod=method; selWaiveReason=null;
  document.querySelectorAll('.wr-btn').forEach(b=>b.classList.remove('sel'));
  const wr=document.getElementById('waive-rs');
  if(method==='waive'){wr.classList.add('show');document.getElementById('pay-confirm-btn').disabled=true;}
  else{wr.classList.remove('show');document.getElementById('pay-confirm-btn').disabled=false;}
}
function selWaive(el,reason){
  document.querySelectorAll('.wr-btn').forEach(b=>b.classList.remove('sel'));
  el.classList.add('sel'); selWaiveReason=reason;
  document.getElementById('pay-confirm-btn').disabled=false;
}
function completePay(){
  const o=orders.find(o=>o.fullId===payingFullId);
  if(!o)return;
  o.status='paid'; o.payMethod=selPayMethod; o.waiveReason=selWaiveReason;
  closePayModal(); renderMerchantOrders(); renderStats();
  if(customerLatestOrder&&customerLatestOrder.fullId===payingFullId) renderCustomerOrderView(o);
  const lbl={cash:'ç°é‡‘',alipay:'æ”¯ä»˜å®',wechat:'å¾®ä¿¡æ”¯ä»˜',waive:'å…å•Â·'+selWaiveReason}[selPayMethod]||'';
  showToast(`âœ… #${o.displayNum} æ”¶æ¬¾å®Œæˆï¼ˆ${lbl}ï¼‰`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let statsFilter='bizday';

function setStatsFilter(f, btn){
  statsFilter = f;
  document.querySelectorAll('#stats-date-filter .df-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderStats();
}

function getFilteredOrders(){
  const paid = orders.filter(o=>o.status==='paid');
  const bizToday = getBizDay();
  const bizYesterday = getBizDay(new Date(Date.now()-86400000));
  const now = new Date();
  const weekStart = new Date(now); weekStart.setDate(now.getDate()-now.getDay());
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

  if(statsFilter==='bizday') return paid.filter(o=>o.bizDay===bizToday);
  if(statsFilter==='yesterday') return paid.filter(o=>o.bizDay===bizYesterday);
  if(statsFilter==='week') return paid.filter(o=>new Date(o.bizDay)>=weekStart);
  if(statsFilter==='month') return paid.filter(o=>new Date(o.bizDay)>=monthStart);
  return paid; // range = all for demo
}

function renderStats(){
  const paid = getFilteredOrders();
  const periodLabels={bizday:'ä»Šæ—¥è¥ä¸šæ—¥',yesterday:'æ˜¨æ—¥',week:'æœ¬å‘¨',month:'æœ¬æœˆ',range:'è‡ªå®šä¹‰åŒºé—´'};
  const rev = paid.filter(o=>o.payMethod!=='waive').reduce((s,o)=>s+o.total,0);
  const cash = paid.filter(o=>o.payMethod==='cash').reduce((s,o)=>s+o.total,0);
  const digital = paid.filter(o=>['alipay','wechat'].includes(o.payMethod)).reduce((s,o)=>s+o.total,0);
  const waiveCnt = paid.filter(o=>o.payMethod==='waive').length;
  const profit = Math.round(rev * 0.45); // 55% cost rate â†’ 45% profit
  const aov = paid.filter(o=>o.payMethod!=='waive').length ? Math.round(rev / paid.filter(o=>o.payMethod!=='waive').length) : 0;

  const se = id => document.getElementById(id);
  if(se('stat-revenue')) se('stat-revenue').textContent='Â¥'+rev;
  if(se('stat-orders-sub')) se('stat-orders-sub').textContent=`å…± ${paid.length} å• Â· å®¢å•ä»· Â¥${aov}`;
  if(se('stats-period-label')) se('stats-period-label').textContent='('+periodLabels[statsFilter]+')';
  if(se('stat-cash')) se('stat-cash').textContent='Â¥'+cash;
  if(se('stat-digital')) se('stat-digital').textContent='Â¥'+digital;
  if(se('stat-waive')) se('stat-waive').textContent=waiveCnt+'å•';
  if(se('stat-profit')) se('stat-profit').textContent='Â¥'+profit;

  renderPeakChart(paid);
  renderTopItems(paid);
}

function renderPeakChart(paid){
  const el = document.getElementById('peak-chart');
  if(!el) return;
  const hours = Array(24).fill(0);
  paid.forEach(o=>hours[o.time.getHours()]++);
  const displayed = [17,18,19,20,21,22,23];
  const max = Math.max(1,...displayed.map(h=>hours[h]));
  el.innerHTML = displayed.map(h=>{
    const cnt = hours[h];
    const h_px = Math.max(4, Math.round((cnt/max)*68));
    return `<div class="bar-col">
      <div class="bar${cnt===Math.max(...displayed.map(h=>hours[h]))?' peak':''}" style="height:${h_px}px"></div>
      <div class="bar-lbl">${h}æ—¶</div>
    </div>`;
  }).join('');
}

function renderTopItems(paid){
  const el = document.getElementById('stats-top-items');
  if(!el) return;
  const counts = {};
  paid.forEach(o=>o.lines.forEach(l=>{
    counts[l.name]=(counts[l.name]||0)+l.qty;
    l.toppings&&l.toppings.forEach(t=>{counts[t.name]=(counts[t.name]||0)+t.qty;});
  }));
  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const maxCnt = sorted[0]?sorted[0][1]:1;
  const ranks=['gold','silver','bronze','','','','','','',''];
  const nums=['â‘ ','â‘¡','â‘¢','â‘£','â‘¤','â‘¥','â‘¦','â‘§','â‘¨','â‘©'];
  el.innerHTML = sorted.length===0
    ? '<div style="font-size:11px;color:#bbb;padding:8px 0">æš‚æ— æ•°æ®</div>'
    : sorted.map((r,i)=>`<div class="top-row">
        <div class="rank ${ranks[i]}">${nums[i]}</div>
        <div class="top-name">${r[0]}</div>
        <div class="top-bar-w"><div class="top-bar-f" style="width:${Math.round(r[1]/maxCnt*100)}%"></div></div>
        <div class="top-cnt">${r[1]}ä»½</div>
      </div>`).join('');
}

function openTopAll(){
  const paid = getFilteredOrders();
  const counts = {};
  paid.forEach(o=>o.lines.forEach(l=>{
    counts[l.name]=(counts[l.name]||0)+l.qty;
    l.toppings&&l.toppings.forEach(t=>{counts[t.name]=(counts[t.name]||0)+t.qty;});
  }));
  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const maxCnt = sorted[0]?sorted[0][1]:1;
  document.getElementById('top-all-content').innerHTML = sorted.length===0
    ? '<div style="font-size:12px;color:#bbb;padding:16px 0">æš‚æ— é”€å”®æ•°æ®</div>'
    : sorted.map((r,i)=>`<div class="top-row">
        <div class="rank ${i<3?['gold','silver','bronze'][i]:''}">${i+1}</div>
        <div class="top-name">${r[0]}</div>
        <div class="top-bar-w"><div class="top-bar-f" style="width:${Math.round(r[1]/maxCnt*100)}%"></div></div>
        <div class="top-cnt">${r[1]}ä»½</div>
      </div>`).join('');
  openSheet('top-all-ov');
}

/* â”€â”€ STAT DETAIL DRILL-DOWN â”€â”€ */
function openStatDetail(type){
  const paid = getFilteredOrders();
  const titles={revenue:'è¥ä¸šé¢æ˜ç»†',cash:'ç°é‡‘æ˜ç»†',digital:'å¾®ä¿¡/æ”¯ä»˜å®æ˜ç»†',waive:'å…å•æ˜ç»†',profit:'åˆ©æ¶¦ä¼°ç®—è¯´æ˜'};
  document.getElementById('stat-detail-title').textContent = titles[type]||'æ˜ç»†';
  let rows=[];
  if(type==='revenue') rows=paid.filter(o=>o.payMethod!=='waive');
  else if(type==='cash') rows=paid.filter(o=>o.payMethod==='cash');
  else if(type==='digital') rows=paid.filter(o=>['alipay','wechat'].includes(o.payMethod));
  else if(type==='waive') rows=paid.filter(o=>o.payMethod==='waive');
  else if(type==='profit'){
    const rev=paid.filter(o=>o.payMethod!=='waive').reduce((s,o)=>s+o.total,0);
    document.getElementById('stat-detail-content').innerHTML=`
      <div class="detail-row"><span class="detail-lbl">è¥ä¸šé¢</span><span class="detail-val">Â¥${rev}</span></div>
      <div class="detail-row"><span class="detail-lbl">é¢„ä¼°æˆæœ¬ï¼ˆ55%ï¼‰</span><span class="detail-val">Â¥${Math.round(rev*0.55)}</span></div>
      <div class="detail-row"><span class="detail-lbl">é¢„ä¼°åˆ©æ¶¦ï¼ˆ45%ï¼‰</span><span class="detail-val" style="color:var(--green)">Â¥${Math.round(rev*0.45)}</span></div>
      <div style="font-size:10px;color:#bbb;margin-top:12px;line-height:1.7">* æˆæœ¬ç‡55%ä¸ºä¼°ç®—å€¼ï¼Œå®é™…åˆ©æ¶¦ä»¥çœŸå®é£Ÿææˆæœ¬ä¸ºå‡†</div>`;
    openSheet('stat-detail-ov');
    return;
  }
  if(rows.length===0){
    document.getElementById('stat-detail-content').innerHTML='<div style="color:#bbb;font-size:12px;padding:16px 0">æš‚æ— æ•°æ®</div>';
  } else {
    const mtd={cash:'ç°é‡‘',alipay:'æ”¯ä»˜å®',wechat:'å¾®ä¿¡',waive:'å…å•'};
    document.getElementById('stat-detail-content').innerHTML=rows.map(o=>`
      <div class="detail-row">
        <div class="detail-lbl">
          #${o.displayNum}
          <span class="detail-tag" style="background:${o.payMethod==='waive'?'#FFF3E0':'var(--green-light)'};color:${o.payMethod==='waive'?'var(--orange)':'var(--green)'}">
            ${mtd[o.payMethod]||''}${o.waiveReason?'Â·'+o.waiveReason:''}
          </span>
          <div style="font-size:9px;color:#bbb">${o.time.toLocaleTimeString('zh')} Â· ${o.lines.map(l=>l.name).join('ã€')}</div>
        </div>
        <div class="detail-val" style="font-size:14px">${o.payMethod!=='waive'?'Â¥'+o.total:'â€”'}</div>
      </div>`).join('');
  }
  openSheet('stat-detail-ov');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSV DOWNLOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function downloadCSV(){
  const paid = orders.filter(o=>o.status==='paid');
  if(paid.length===0){showToast('âš ï¸ æš‚æ— å·²å®Œæˆè®¢å•æ•°æ®');return;}
  const rows=[['åˆ†åº—ID','åˆ†åº—å','åˆ†æ”¯','è¥ä¸šæ—¥','æ—¥æœŸæ—¶é—´','å®Œæ•´è®¢å•å·','å–é¤å·','æ”¯ä»˜æ–¹å¼','å…å•ç†ç”±','ä¸»èœå','ä¸»èœæ•°é‡','ä¸»èœå•ä»·','ä¸»èœé‡‘é¢','é…æ–™å','é…æ–™æ•°é‡','é…æ–™å•ä»·','é…æ–™é‡‘é¢','å¤‡æ³¨è§„æ ¼']];
  paid.forEach(o=>{
    o.lines.forEach(l=>{
      if(l.toppings&&l.toppings.length){
        l.toppings.forEach(t=>{
          rows.push([
            o.storeId,o.storeName,o.branch,o.bizDay,
            o.time.toISOString(),o.fullId,o.displayNum,
            o.payMethod,o.waiveReason||'',
            l.name,l.qty,l.unitPrice,l.lineTotal,
            t.name,t.qty,t.unitPrice,t.unitPrice*t.qty,
            l.spec.replace(/\n/g,' ')
          ]);
        });
      } else {
        rows.push([
          o.storeId,o.storeName,o.branch,o.bizDay,
          o.time.toISOString(),o.fullId,o.displayNum,
          o.payMethod,o.waiveReason||'',
          l.name,l.qty,l.unitPrice,l.lineTotal,
          '','','','',
          l.spec.replace(/\n/g,' ')
        ]);
      }
    });
  });
  const csv=rows.map(r=>r.map(v=>'"'+(String(v||'').replace(/"/g,'""'))+'"').join(',')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`å°è°¢èºè›³ç²‰_é”€å”®æ•°æ®_${fmtDate(new Date())}.csv`;
  a.click();
  showToast('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function triggerPrint(order, isReprint=false){
  order.printed=true;
  document.getElementById('pn-text').textContent=isReprint?`é‡æ–°æ‰“å° #${order.displayNum}`:`æ–°è®¢å• #${order.displayNum} Â· æ­£åœ¨æ‰“å°`;
  document.getElementById('pn-sub').textContent=order.lines.map(l=>l.name+'Ã—'+l.qty).join('ã€');
  const n=document.getElementById('print-notif');
  const f=document.getElementById('pn-fill');
  n.classList.add('show'); f.style.width='0';
  setTimeout(()=>{f.style.width='100%';},80);
  setTimeout(()=>{n.classList.remove('show');},3800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MENU MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMenuManage(){
  const el=document.getElementById('menu-manage-list');
  if(!el)return;
  const itemsHtml=DB.cats().map(c=>{
    const its=[...DB.items.filter(i=>i.cat===c)].sort((a,b)=>b.on-a.on);
    return `<div>
      <div class="mg-sec-title">${DB.CE[c]} ${DB.CL[c]}</div>
      ${its.map(item=>`
        <div class="mg-item" style="${!item.on?'opacity:0.5':''}">
          <div><div class="mg-name">${item.name}</div><div class="mg-price">Â¥${item.price}</div></div>
          <div class="mg-actions">
            <div class="tog${item.on?' on':''}" onclick="toggleOn(${item.id},this)"><div class="tog-knob"></div></div>
            <button class="ebtn edit" onclick="openEdit(${item.id},false,'item')">ç¼–è¾‘</button>
            <button class="ebtn del" onclick="delItem(${item.id})">åˆ é™¤</button>
          </div>
        </div>`).join('')}
    </div>`;
  }).join('');
  const sortedTops=[...DB.toppings].sort((a,b)=>b.on-a.on);
  const topsHtml=`<div>
    <div class="mg-sec-title" style="display:flex;justify-content:space-between;align-items:center;padding-right:13px">
      <span>ğŸ¥© èºè›³ç²‰é…æ–™</span>
      <button onclick="openEdit(-1,true,'topping')" style="background:var(--orange);color:#fff;border:none;border-radius:5px;padding:2px 8px;font-size:9px;font-weight:600;cursor:pointer">+é…æ–™</button>
    </div>
    ${sortedTops.map(t=>`
      <div class="mg-item" style="${!t.on?'opacity:0.5':''}">
        <div><div class="mg-name">${t.name}</div><div class="mg-price">+Â¥${t.price}${!t.on?' Â· ä¼°æ¸…':''}</div></div>
        <div class="mg-actions">
          <div class="tog${t.on?' on':''}" onclick="toggleTopOn('${t.id}',this)"><div class="tog-knob"></div></div>
          <button class="ebtn edit" onclick="openEdit('${t.id}',false,'topping')">ç¼–è¾‘</button>
          <button class="ebtn del" onclick="delTopping('${t.id}')">åˆ é™¤</button>
        </div>
      </div>`).join('')}
  </div>`;
  el.innerHTML=itemsHtml+topsHtml;
}

function toggleOn(id,el){
  const item=DB.items.find(i=>i.id===id);
  item.on=!item.on; el.classList.toggle('on',item.on);
  renderCustomerMenu(); renderCombo();
  showToast(item.on?`âœ… ${item.name} å·²ä¸Šæ¶`:`â¸ ${item.name} å·²ä¸‹æ¶`);
}
function toggleTopOn(tid,el){
  const top=DB.toppings.find(t=>t.id===tid);
  top.on=!top.on; renderMenuManage(); renderToppings();
  showToast(top.on?`âœ… ${top.name} å·²ä¸Šæ¶`:`â¸ ${top.name} ä¼°æ¸…`);
}

let editingId=null, editingType='item';
function openEdit(id,isNew,type='item'){
  editingId=isNew?null:id; editingType=type;
  const isTop=(type==='topping');
  document.getElementById('edit-title').textContent=isNew?(isTop?'æ·»åŠ é…æ–™':'æ·»åŠ èœå“'):(isTop?'ç¼–è¾‘é…æ–™':'ç¼–è¾‘èœå“');
  document.getElementById('edit-cat-row').style.display=isTop?'none':'block';
  if(isNew){
    document.getElementById('edit-name').value='';
    document.getElementById('edit-price').value='';
    document.getElementById('edit-cat').value='noodles';
    document.getElementById('edit-tog').className='tog on';
  } else if(isTop){
    const top=DB.toppings.find(t=>t.id===id);
    document.getElementById('edit-name').value=top.name;
    document.getElementById('edit-price').value=top.price;
    document.getElementById('edit-tog').className='tog'+(top.on?' on':'');
  } else {
    const item=DB.items.find(i=>i.id===id);
    document.getElementById('edit-name').value=item.name;
    document.getElementById('edit-price').value=item.price;
    document.getElementById('edit-cat').value=item.cat;
    document.getElementById('edit-tog').className='tog'+(item.on?' on':'');
  }
  document.getElementById('edit-ov').classList.add('show');
}
function closeEdit(){document.getElementById('edit-ov').classList.remove('show');}
function maybeCloseEdit(e){if(e.target.id==='edit-ov')closeEdit();}
function saveEdit(){
  const name=document.getElementById('edit-name').value.trim();
  const price=parseFloat(document.getElementById('edit-price').value);
  const cat=document.getElementById('edit-cat').value;
  const on=document.getElementById('edit-tog').classList.contains('on');
  if(!name||isNaN(price)){showToast('âš ï¸ è¯·å¡«å†™åç§°å’Œä»·æ ¼');return;}
  if(editingType==='topping'){
    if(editingId===null) DB.toppings.push({id:DB.nextTopId(),name,price,on});
    else Object.assign(DB.toppings.find(t=>t.id===editingId),{name,price,on});
  } else {
    if(editingId===null) DB.items.push({id:DB.nextId(),cat,name,desc:'',price,on,hot:false});
    else Object.assign(DB.items.find(i=>i.id===editingId),{name,price,cat,on});
  }
  closeEdit(); renderAll();
  showToast(editingId===null?'âœ… å·²æ·»åŠ ':'âœ… å·²æ›´æ–°');
}
function delItem(id){
  const item=DB.items.find(i=>i.id===id);
  if(!item)return;
  DB.items.splice(DB.items.indexOf(item),1);
  renderAll(); showToast(`ğŸ—‘ ã€Œ${item.name}ã€å·²åˆ é™¤`);
}
function delTopping(tid){
  const top=DB.toppings.find(t=>t.id===tid);
  if(!top)return;
  DB.toppings.splice(DB.toppings.indexOf(top),1);
  renderAll(); showToast(`ğŸ—‘ ã€Œ${top.name}ã€å·²åˆ é™¤`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showTab(v, btn){
  ['menu','order','merchant'].forEach(x=>document.getElementById('view-'+x).style.display='none');
  document.getElementById('view-'+v).style.display='flex';
  if(btn){document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
  if(v==='merchant') updateBizDayLabel();
}
function switchCat(el,catId){
  document.querySelectorAll('.cat-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');
  document.querySelectorAll('[id^="ccat-"]').forEach(d=>d.style.display='none');
  document.getElementById(catId).style.display='block';
}
function mNav(btn,id){
  document.querySelectorAll('.m-nav-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  ['m-orders','m-stats','m-menu'].forEach(i=>{
    const el=document.getElementById(i);
    if(el) el.style.display='none';
  });
  document.getElementById(id).style.display='flex';
  document.getElementById(id).style.flexDirection='column';
  if(id==='m-stats') renderStats();
}

/* â”€â”€ SHEET HELPERS â”€â”€ */
function openSheet(id){ document.getElementById(id).classList.add('show'); }
function closeSheet(id){ document.getElementById(id).classList.remove('show'); }
function maybeClose(e, id){ if(e.target.id===id) closeSheet(id); }

/* â”€â”€ TOAST â”€â”€ */
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.transform='translateX(-50%) translateY(0)';
  setTimeout(()=>{t.style.transform='translateX(-50%) translateY(90px)';},3000);
}

/* â•â• INIT â•â• */
renderAll();
// hide date filter initially (active tab is showing)
document.getElementById('order-date-filter').style.display='none';
</script>
</body>
</html>
